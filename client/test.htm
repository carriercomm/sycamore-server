<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="socket.io.js"></script>
<script type="text/javascript">

io.setPath('./');


function serverConnection(config){

	var self = this;

	this.config = config;
	this.online = false;
	this.pingTimer = null;
	this.giveupTimer = null;
	this.lastConnected = 0;
	this.eventHandlers = {};

	this.socket = new io.Socket(config.host, {
		port: config.port
		//transports: ['xhr-polling']
	});


	//
	// set up the socket object
	//

	this.socket.on('connect', function(){

		self.lastConnected = new Date().getTime();

		self.emit('connected');
		self.emit('state', 'connected');
	});

	this.socket.on('close', function(){
		//console.log('closed');
	});

	this.socket.on('disconnect', function(){

		self.emit('disconnected');
		self.emit('state', 'disconnected');

		// if we get disconnected, we will immediately
		// try to reconnect. if we went offline on purpose,
		// self.online will be false so reconnect() will
		// just no-op.

		self.reconnect();
	});

	this.socket.on('message', function(data){

		if (data.msg == 'pong'){
			if (!self.socket.connected) return;
			var diff = (new Date().getTime()) - data.t;
			if (diff < 0) diff = 0;
			self.emit('state', 'connected', diff);
			//console.log('lag: '+diff);
			return;
		}

		self.emit('message', data);
	});


	//
	// event handlers
	//

	this.on = function(ev, f){
		if (!self.eventHandlers[ev]){
			self.eventHandlers[ev] = [];
		}
		self.eventHandlers[ev].push(f);
	};

	this.emit = function(){
		var args = Array.prototype.slice.call(arguments);
		var ev = args.shift();
		if (self.eventHandlers[ev]){
			for (var i=0; i<self.eventHandlers[ev].length; i++){
				var f = self.eventHandlers[ev][i];
				f.apply(self, args);
			}
		}
	}


	//
	// the real guts
	//

	this.brace_for_failure = function(){

		// this timer is set up so that we can decide to just stop trying
		// after a certain period.

		if (self.giveupTimer) window.clearTimeout(self.giveupTimer);
		self.giveupTimer = window.setTimeout(function(){ self.giveup(); }, self.config.giveup_interval);
	}

	this.connect = function(){
		self.online = true;
		self.emit('state', 'connecting');

		self.brace_for_failure();
		self.socket.connect();
	}

	this.reconnect = function(){
		if (!self.online) return;
		self.emit('state', 'reconnecting');

		self.brace_for_failure();
		self.socket.connect();
	}

	this.giveup = function(){
		window.clearTimeout(self.giveupTimer);
		self.giveupTimer = null;
		if (self.socket.connected) return;

		self.emit('state', 'disconnected');
	}


	//
	// ping is a simple interval - if we're connected, send
	// a ping message. if not, do nothing
	//

	self.pingTimer = window.setInterval(function(){
		if (self.socket.connected){
			self.socket.send({msg: 'ping', t: new Date().getTime()});
		}
	}, self.config.ping_interval);


	//
	// toggle the client on and off
	//

	this.go_online = function(){
		if (self.socket.connected) return;
		self.online = true;
		self.reconnect();
	}

	this.go_offline = function(){
		self.online = false;
		if (self.socket.connected) self.socket.disconnect();
	}


	//
	// send a message
	//

	this.send = function(msg){
		self.socket.send(msg);
	};


	// delay this call so that the caller can set up event handlers
	window.setTimeout(function(){ self.connect(); }, 0);
}

var con;

$(document).ready(function(){

	con = new serverConnection({
		host		: 'iamcal.com',
		port		: 8080,
		ping_interval	: 3000,
		giveup_interval	: 10000
	});

	con.on('state', function(state, lag){
		switch (state){
			case 'connected':
				$('#con').addClass('online').removeClass('offline');
				$('#lag').text(lag ? lag+'ms' : 'Connected');
				break;

			case 'disconnected':
				$('#con').removeClass('online').addClass('offline');
				$('#lag').text('Disconnected');
				break;

			case 'connecting':
				$('#con').removeClass('online').removeClass('offline');
				$('#lag').text('Connecting...');
				break;

			case 'reconnecting':
				$('#con').removeClass('online').removeClass('offline');
				$('#lag').text('Reconnecting...');
				break;

			default:
				$('#con').removeClass('online').removeClass('offline');
				$('#lag').text('Unknown: '+state);
		}
	});


	con.on('message', function(msg){

		switch (msg.msg){
			case 'welcome': return handleWelcome(msg);
			case 'joined': return handleJoined(msg);
			case 'left': return handleLeft(msg);
			case 'moved': return handleMoved(msg);
		}

		console.log('got a message!', msg);
	});

	con.on('connected', function(){

		con.send({msg: 'some data'});
	});

	$('#playarea').click(function(e){
		var x = e.layerX;
		var y = e.layerY;
		con.send({msg: 'move', x:x, y:y});
	});
});

function handleWelcome(msg){
	$('#onlinelistplayers').html('');
	$('#playarea').html('');

	for (var i in msg.players){
		addPlayer(i, msg.players[i]);
	}
}

function addPlayer(uid, p){

console.log(p);

	var txt = uid+": "+p.x+","+p.y;
	if (p.self) txt += " (you)";
	var d = $('<div>').text(txt);
	d.attr('id', 'players-'+uid);
	$('#onlinelistplayers').append(d);

	var dude = $('<div>').addClass('dude');
	dude.css({left: (p.x-7)+'px', top: (p.y-22)+'px'});
	dude.attr('id', 'players-dudes-'+uid);
	if (p.self) dude.css({backgroundColor: 'rgba(0,255,0,0.5)'});
	$('#playarea').append(dude);
}

function handleJoined(msg){
	addPlayer(msg.uid, msg.player);
}

function handleLeft(msg){
	$('#players-'+msg.uid).remove();
	$('#players-dudes-'+msg.uid).remove();
}

function handleMoved(msg){

	$('#players-dudes-'+msg.uid).css({left: (msg.x-7)+'px', top: (msg.y-22)+'px'});
}

</script>
<style>

body {
	font-family: Arial, Helvetica, sans-serif;
}

#statusbar {
	position: absolute;
	top: 0px;
	left: 20px;
	right: 20px;
	height: 20px;
	padding: 6px 20px;

	-moz-border-radius-bottomleft: 10px;
	-moz-border-radius-bottomright: 10px;
	border-bottom-left-radius: 10px;
	border-bottom-right-radius: 10px;

	border-left: 1px solid #C7C7C7;
	border-right: 1px solid #C7C7C7;
	border-bottom: 1px solid #C7C7C7;

	background-color: #fff;
	background-image: -moz-linear-gradient(center bottom, rgb(233,233,233) 0%, rgb(255,255,255) 100%);
	background-image: -webkit-gradient(linear, left bottom, left top, color-stop(1, rgb(233,233,233)), color-stop(0, rgb(255,255,255)));

	-moz-box-shadow:	inset 0 0 15px 1px rgba(255,255,255, 0.5), 0 1px 3px #999;
	-webkit-box-shadow:	inset 0 0 15px 1px rgba(255,255,255, 0.5), 0 1px 3px #999;
	box-shadow:		inset 0 0 15px 1px rgba(255,255,255, 0.5), 0 1px 3px #999;
}

#constatus {
	float: right;
	line-height: 20px;
	font-size: 12px;
	text-shadow: #fff 1px 1px;
}

#con {
	width: 16px;
	height: 16px;
	border: 1px solid #000;
	background-color: red;
	margin-right: 8px;
	float: left;
}
#con.online { background-color: lime; }
#con.offline { background-color: #999; }

#onlinelist {
	position: absolute;
	left: 30px;
	top: 100px;
	border: 1px solid #666;
	background-color: #f5f5f5;
	padding: 1em;
}

#playarea {
	position: absolute;
	left: 400px;
	top: 100px;
	width: 400px;
	height: 400px;
	border: 1px solid #666;
	background-color: #f5f5f5;
}

.dude {
	position: absolute;
	width: 15px;
	height: 22px;
	background-image: url(bunny.gif);
}

</style>

<div id="statusbar">
	<div id="constatus">
		<div id="con"></div>
		<span id="lag">Disconnected</span>
	</div>
</div>

<div id="onlinelist">
	<b>Players Online</b><br />
	<div id="onlinelistplayers"></div>
</div>

<div id="playarea">
</div>
